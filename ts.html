<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Recherche de Stage - Pierre DUMONT ROTY</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: center;
        }

        .filters select, .filters input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filters select:focus, .filters input:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .add-form.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group textarea {
            resize: vertical;
            height: 80px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-candidature {
            background: #ffeaa7;
            color: #2d3436;
        }

        .status-entretien {
            background: #74b9ff;
            color: white;
        }

        .status-accepte {
            background: #00b894;
            color: white;
        }

        .status-refuse {
            background: #e17055;
            color: white;
        }

        .status-attente {
            background: #a29bfe;
            color: white;
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .export-section {
            margin-top: 30px;
            text-align: center;
        }

        .lien-info {
            border-radius: 5px;
            padding: 8px;
            margin-top: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .lien-info.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .lien-info.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .lien-info.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .auto-fill-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #2196f3;
        }

        .auto-fill-section h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
            font-size: 14px;
        }

        .auto-fill-section p {
            margin: 0;
            font-size: 12px;
            color: #424242;
            line-height: 1.4;
        }

        .supported-sites {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .site-badge {
            background: #ffffff;
            border: 1px solid #2196f3;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px;
            }

            .supported-sites {
                justify-content: center;
            }
        }

        /* Modal mapping CSV */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            width: 95%;
            max-width: 1100px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .modal-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-body {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            padding: 16px;
            max-height: 60vh;
            overflow: auto;
        }

        .modal-section {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
        }

        .preview-table th, .preview-table td {
            border: 1px solid #e9ecef;
            padding: 6px;
            font-size: 12px;
        }

        .mapping-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
        }

        .mapping-label { width: 40%; font-weight: bold; }
        .mapping-select { width: 58%; }

        .modal-footer {
            padding: 12px 16px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            background: #ffffff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📋 Suivi de Recherche de Stage</h1>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalCandidatures">0</div>
                <div class="stat-label">Candidatures</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalEntretiens">0</div>
                <div class="stat-label">Entretiens</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalAcceptes">0</div>
                <div class="stat-label">Acceptés</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="tauxReponse">0%</div>
                <div class="stat-label">Taux de Réponse</div>
            </div>
        </div>

        <div class="filters">
            <input type="text" id="searchInput" placeholder="🔍 Rechercher par entreprise ou poste...">
            <select id="statusFilter">
                <option value="">Tous les statuts</option>
                <option value="candidature">Candidature envoyée</option>
                <option value="entretien">Entretien planifié</option>
                <option value="accepte">Accepté</option>
                <option value="refuse">Refusé</option>
                <option value="attente">En attente</option>
            </select>
            <select id="sortBy">
                <option value="date">Trier par date</option>
                <option value="entreprise">Trier par entreprise</option>
                <option value="statut">Trier par statut</option>
            </select>
            <button class="btn" onclick="toggleAddForm()">➕ Ajouter un Stage</button>
        </div>

        <div class="add-form" id="addForm">
            <h3>Ajouter une nouvelle candidature</h3>
            
            <div class="auto-fill-section">
                <h4>🚀 Remplissage automatique disponible</h4>
                <p>Collez le lien de l'annonce et cliquez sur "Pré-remplir" pour extraire automatiquement les informations !</p>
                <div class="supported-sites">
                    <span class="site-badge">Welcome to the Jungle</span>
                    <span class="site-badge">Indeed</span>
                    <span class="site-badge">LinkedIn</span>
                    <span class="site-badge">Autres sites</span>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Entreprise *</label>
                    <input type="text" id="entreprise" required>
                </div>
                <div class="form-group">
                    <label>Poste *</label>
                    <input type="text" id="poste" required>
                </div>
                <div class="form-group">
                    <label>Lieu</label>
                    <input type="text" id="lieu">
                </div>
                <div class="form-group">
                    <label>Date de candidature</label>
                    <input type="date" id="dateCandidature">
                </div>
                <div class="form-group">
                    <label>Statut</label>
                    <select id="statut">
                        <option value="candidature">Candidature envoyée</option>
                        <option value="entretien">Entretien planifié</option>
                        <option value="accepte">Accepté</option>
                        <option value="refuse">Refusé</option>
                        <option value="attente">En attente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Contact</label>
                    <input type="text" id="contact" placeholder="Nom du recruteur">
                </div>
                <div class="form-group">
                    <label>Email/Téléphone</label>
                    <input type="text" id="contactInfo" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label>Salaire proposé</label>
                    <input type="text" id="salaire" placeholder="Ex: 600€/mois">
                </div>
                <div class="form-group">
                    <label>Lien de l'annonce</label>
                    <input type="url" id="lienAnnonce" placeholder="https://www.welcometothejungle.com/fr/companies/...">
                </div>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="notes" placeholder="Informations complémentaires, retours d'entretien..."></textarea>
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-secondary" onclick="remplirDepuisLien()">🔗 Pré-remplir depuis l'annonce</button>
            </div>
            <div>
                <button class="btn" onclick="ajouterStage()">💾 Enregistrer</button>
                <button class="btn btn-secondary" onclick="toggleAddForm()">❌ Annuler</button>
            </div>
        </div>

        <table id="stageTable">
            <thead>
                <tr>
                    <th>Entreprise</th>
                    <th>Poste</th>
                    <th>Lieu</th>
                    <th>Date</th>
                    <th>Statut</th>
                    <th>Contact</th>
                    <th>Salaire</th>
                    <th>Annonce</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="stageTableBody">
                <!-- Les données seront ajoutées dynamiquement -->
            </tbody>
        </table>

        <div class="export-section">
            <button class="btn btn-success" onclick="exporterCSV()">📊 Exporter en CSV</button>
            <button class="btn btn-secondary" onclick="importerDonnees()">📥 Importer des données (JSON)</button>
            <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="chargerFichier()">
            <button class="btn" onclick="importerDonneesLinkedIn()">🔁 Importer depuis l'export LinkedIn</button>
            <input type="file" id="linkedinFileInput" accept=".json,.csv" style="display: none;" onchange="chargerFichierLinkedIn()">
        </div>

        <!-- Modal d'import / mapping CSV -->
        <div id="mappingModalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
            <div class="modal" role="document">
                <div class="modal-header">
                    <div>
                        <strong id="modalTitle">Importer CSV — Mapper les colonnes</strong>
                        <div id="modalSubtitle" style="font-size:12px; opacity:0.9"></div>
                    </div>
                    <div>
                        <button class="btn btn-secondary" onclick="closeMappingModal()">Fermer</button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="modal-section">
                        <h4>Colonnes détectées</h4>
                        <div id="detectedColumns" style="max-height:320px; overflow:auto;"></div>
                        <div style="margin-top:8px;"><button class="btn" onclick="guessMapping()">Deviner automatiquement</button></div>
                    </div>
                    <div class="modal-section">
                        <h4>Prévisualisation (brute)</h4>
                        <div id="previewRaw" style="max-height:360px; overflow:auto;"></div>
                    </div>
                    <div class="modal-section">
                        <h4>Mapping vers champs</h4>
                        <div id="mappingFields" style="max-height:360px; overflow:auto;"></div>
                        <div style="margin-top:8px; font-size:12px; color:#555;">Options: <label><input type="checkbox" id="optIgnoreMissing"> Ignorer lignes sans Entreprise/ Poste</label></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeMappingModal()">Annuler</button>
                    <button class="btn btn-success" onclick="applyMappingImport()">Importer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let stages = [];
        let editingIndex = -1;

        // Charger les données depuis localStorage au démarrage
        window.onload = function() {
            chargerDonnees();
            document.getElementById('dateCandidature').value = new Date().toISOString().split('T')[0];
        };

        function toggleAddForm() {
            const form = document.getElementById('addForm');
            if (form.classList.contains('active')) {
                form.classList.remove('active');
                resetForm();
            } else {
                form.classList.add('active');
            }
        }

        function ajouterStage() {
            const stage = {
                entreprise: document.getElementById('entreprise').value,
                poste: document.getElementById('poste').value,
                lieu: document.getElementById('lieu').value,
                date: document.getElementById('dateCandidature').value,
                statut: document.getElementById('statut').value,
                contact: document.getElementById('contact').value,
                contactInfo: document.getElementById('contactInfo').value,
                salaire: document.getElementById('salaire').value,
                lienAnnonce: document.getElementById('lienAnnonce').value,
                notes: document.getElementById('notes').value,
                id: editingIndex >= 0 ? stages[editingIndex].id : Date.now()
            };

            if (!stage.entreprise || !stage.poste) {
                alert('Veuillez remplir au moins l\'entreprise et le poste.');
                return;
            }

            if (editingIndex >= 0) {
                stages[editingIndex] = stage;
                editingIndex = -1;
            } else {
                stages.push(stage);
            }

            sauvegarderDonnees();
            afficherStages();
            resetForm();
            toggleAddForm();
            mettreAJourStatistiques();
        }

        function resetForm() {
            document.getElementById('entreprise').value = '';
            document.getElementById('poste').value = '';
            document.getElementById('lieu').value = '';
            document.getElementById('dateCandidature').value = new Date().toISOString().split('T')[0];
            document.getElementById('statut').value = 'candidature';
            document.getElementById('contact').value = '';
            document.getElementById('contactInfo').value = '';
            document.getElementById('salaire').value = '';
            document.getElementById('lienAnnonce').value = '';
            document.getElementById('notes').value = '';
            editingIndex = -1;
        }

        function modifierStage(index) {
            const stage = stages[index];
            document.getElementById('entreprise').value = stage.entreprise;
            document.getElementById('poste').value = stage.poste;
            document.getElementById('lieu').value = stage.lieu;
            document.getElementById('dateCandidature').value = stage.date;
            document.getElementById('statut').value = stage.statut;
            document.getElementById('contact').value = stage.contact;
            document.getElementById('contactInfo').value = stage.contactInfo;
            document.getElementById('salaire').value = stage.salaire;
            document.getElementById('lienAnnonce').value = stage.lienAnnonce || '';
            document.getElementById('notes').value = stage.notes;
            
            editingIndex = index;
            document.getElementById('addForm').classList.add('active');
        }

        function supprimerStage(index) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette candidature ?')) {
                stages.splice(index, 1);
                sauvegarderDonnees();
                afficherStages();
                mettreAJourStatistiques();
            }
        }

        function afficherStages() {
            const tbody = document.getElementById('stageTableBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            let stagesFiltres = stages.filter(stage => {
                const matchesSearch = stage.entreprise.toLowerCase().includes(searchTerm) || 
                                    stage.poste.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || stage.statut === statusFilter;
                return matchesSearch && matchesStatus;
            });

            // Tri
            stagesFiltres.sort((a, b) => {
                if (sortBy === 'date') return new Date(b.date) - new Date(a.date);
                if (sortBy === 'entreprise') return a.entreprise.localeCompare(b.entreprise);
                if (sortBy === 'statut') return a.statut.localeCompare(b.statut);
                return 0;
            });

            tbody.innerHTML = '';
            stagesFiltres.forEach((stage, index) => {
                const originalIndex = stages.indexOf(stage);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${stage.entreprise}</strong></td>
                    <td>${stage.poste}</td>
                    <td>${stage.lieu}</td>
                    <td>${stage.date ? new Date(stage.date).toLocaleDateString('fr-FR') : ''}</td>
                    <td><span class="status-badge status-${stage.statut}">${getStatusText(stage.statut)}</span></td>
                    <td>${stage.contact}<br><small>${stage.contactInfo}</small></td>
                    <td>${stage.salaire}</td>
                    <td>${stage.lienAnnonce ? `<a href="${stage.lienAnnonce}" target="_blank" title="Voir l'annonce">🔗</a>` : ''}</td>
                    <td>${stage.notes.length > 50 ? stage.notes.substring(0, 50) + '...' : stage.notes}</td>
                    <td class="actions">
                        <button class="btn btn-small" onclick="modifierStage(${originalIndex})" title="Modifier">✏️</button>
                        <button class="btn btn-danger btn-small" onclick="supprimerStage(${originalIndex})" title="Supprimer">🗑️</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusText(status) {
            const statusTexts = {
                'candidature': 'Candidature',
                'entretien': 'Entretien',
                'accepte': 'Accepté',
                'refuse': 'Refusé',
                'attente': 'En attente'
            };
            return statusTexts[status] || status;
        }

        function mettreAJourStatistiques() {
            const total = stages.length;
            const entretiens = stages.filter(s => s.statut === 'entretien' || s.statut === 'accepte').length;
            const acceptes = stages.filter(s => s.statut === 'accepte').length;
            const reponses = stages.filter(s => s.statut !== 'candidature' && s.statut !== 'attente').length;
            const tauxReponse = total > 0 ? Math.round((reponses / total) * 100) : 0;

            document.getElementById('totalCandidatures').textContent = total;
            document.getElementById('totalEntretiens').textContent = entretiens;
            document.getElementById('totalAcceptes').textContent = acceptes;
            document.getElementById('tauxReponse').textContent = tauxReponse + '%';
        }

        function sauvegarderDonnees() {
            localStorage.setItem('stagesData', JSON.stringify(stages));
        }

        function chargerDonnees() {
            const data = localStorage.getItem('stagesData');
            if (data) {
                stages = JSON.parse(data);
                afficherStages();
                mettreAJourStatistiques();
            }
        }

        function exporterCSV() {
            const headers = ['Entreprise', 'Poste', 'Lieu', 'Date', 'Statut', 'Contact', 'Contact Info', 'Salaire', 'Lien Annonce', 'Notes'];
            const csvContent = [
                headers.join(','),
                ...stages.map(stage => [
                    stage.entreprise,
                    stage.poste,
                    stage.lieu,
                    stage.date,
                    getStatusText(stage.statut),
                    stage.contact,
                    stage.contactInfo,
                    stage.salaire,
                    stage.lienAnnonce || '',
                    stage.notes.replace(/,/g, ';')
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `recherche_stages_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function importerDonnees() {
            document.getElementById('fileInput').click();
        }

        function chargerFichier() {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData)) {
                            stages = importedData;
                            sauvegarderDonnees();
                            afficherStages();
                            mettreAJourStatistiques();
                            alert('Données importées avec succès !');
                        }
                    } catch (error) {
                        alert('Erreur lors de l\'importation du fichier.');
                    }
                };
                reader.readAsText(file);
            }
        }

        // ---- Importateur LinkedIn (JSON/CSV) ----
        function importerDonneesLinkedIn() {
            // Brève instruction avant d'importer
            const info = "Pour obtenir l'export officiel LinkedIn : allez sur LinkedIn → Paramètres & Confidentialité → Données et confidentialité → Obtenir une copie de vos données (Get a copy of your data). Choisissez JSON ou CSV pour les données des candidatures/offres si disponible. Ensuite importez le fichier ici.";
            if (!confirm(info + "\n\nCliquer OK pour choisir un fichier export LinkedIn (JSON/CSV).")) return;
            document.getElementById('linkedinFileInput').click();
        }

        function chargerFichierLinkedIn() {
            const file = document.getElementById('linkedinFileInput').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    let records = [];

                    if (file.name.toLowerCase().endsWith('.json')) {
                        const parsed = JSON.parse(text);
                        // If LinkedIn export wraps data, try to find plausible arrays
                        if (Array.isArray(parsed)) {
                            records = parsed;
                        } else {
                            // try to find first array property
                            for (const k in parsed) {
                                if (Array.isArray(parsed[k])) { records = parsed[k]; break; }
                            }
                        }
                    } else if (file.name.toLowerCase().endsWith('.csv')) {
                        // For CSV, parse and open mapping modal so user can map columns
                        const rows = parseCSV(text);
                        if (!rows || rows.length === 0) { alert('Aucun enregistrement trouvé dans le CSV.'); return; }
                        const headers = Object.keys(rows[0]);
                        const preview = rows.slice(0,5);
                        showMappingModal(headers, preview, rows, file.name);
                        return;
                    } else {
                        alert('Format non supporté. Veuillez fournir un .json ou .csv.');
                        return;
                    }

                    if (!records || records.length === 0) {
                        alert('Aucun enregistrement trouvé dans le fichier LinkedIn.');
                        return;
                    }

                    let importedCount = 0;
                    records.forEach(rec => {
                        const stage = mapLinkedInRecord(rec);
                        if (stage) {
                            // éviter doublons basiques : même lien d'annonce ou même entreprise+poste+date
                            const exists = stages.some(s => (s.lienAnnonce && s.lienAnnonce === stage.lienAnnonce) || (s.entreprise === stage.entreprise && s.poste === stage.poste && s.date === stage.date));
                            if (!exists) {
                                stages.push(stage);
                                importedCount++;
                            }
                        }
                    });

                    sauvegarderDonnees();
                    afficherStages();
                    mettreAJourStatistiques();

                    alert('Import terminé. ' + importedCount + ' nouvelles candidatures ajoutées.');
                } catch (err) {
                    console.error(err);
                    alert('Erreur lors de l\'analyse du fichier LinkedIn. Vérifiez le format.');
                }
            };
            reader.readAsText(file);
        }

        // --- Modal mapping helpers ---
        let currentAllRows = null;
        let currentHeaders = null;

        function showMappingModal(headers, previewRows, allRows, fileName) {
            currentAllRows = allRows;
            currentHeaders = headers;
            document.getElementById('modalTitle').textContent = 'Importer: ' + fileName;
            document.getElementById('modalSubtitle').textContent = headers.length + ' colonnes détectées';

            // detected columns list
            const detectedDiv = document.getElementById('detectedColumns');
            detectedDiv.innerHTML = '';
            headers.forEach(h => {
                const p = document.createElement('div');
                p.style.padding = '6px 4px';
                p.style.borderBottom = '1px solid #eee';
                p.innerHTML = `<strong>${h}</strong><div style="font-size:12px; color:#555;">${previewRows.map(r => (r[h]||'')).slice(0,3).join(' | ')}</div>`;
                detectedDiv.appendChild(p);
            });

            // preview raw
            const previewDiv = document.getElementById('previewRaw');
            previewDiv.innerHTML = '';
            const table = document.createElement('table');
            table.className = 'preview-table';
            const thead = document.createElement('thead');
            const trh = document.createElement('tr');
            headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); });
            thead.appendChild(trh);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            previewRows.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(h => { const td = document.createElement('td'); td.textContent = row[h] || ''; tr.appendChild(td); });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            previewDiv.appendChild(table);

            // mapping fields
            const targets = ['entreprise','poste','lieu','date','statut','contact','contactInfo','salaire','lienAnnonce','notes'];
            const targetLabels = { entreprise:'Entreprise', poste:'Poste', lieu:'Lieu', date:'Date', statut:'Statut', contact:'Contact', contactInfo:'Contact Info', salaire:'Salaire', lienAnnonce:'LienAnnonce', notes:'Notes' };

            const mappingDiv = document.getElementById('mappingFields');
            mappingDiv.innerHTML = '';
            targets.forEach(t => {
                const row = document.createElement('div');
                row.className = 'mapping-row';
                const label = document.createElement('div'); label.className = 'mapping-label'; label.textContent = targetLabels[t];
                const sel = document.createElement('select'); sel.className = 'mapping-select'; sel.id = 'map_' + t;
                const optNone = document.createElement('option'); optNone.value = '__NONE__'; optNone.textContent = 'Ignorer / Aucun'; sel.appendChild(optNone);
                headers.forEach(h => { const o = document.createElement('option'); o.value = h; o.textContent = h; sel.appendChild(o); });
                row.appendChild(label); row.appendChild(sel);
                mappingDiv.appendChild(row);
            });

            // open modal
            const overlay = document.getElementById('mappingModalOverlay');
            overlay.classList.add('active');
            overlay.setAttribute('aria-hidden','false');
        }

        function closeMappingModal() {
            const overlay = document.getElementById('mappingModalOverlay');
            overlay.classList.remove('active');
            overlay.setAttribute('aria-hidden','true');
            currentAllRows = null; currentHeaders = null;
        }

        function guessMapping() {
            if (!currentHeaders) return;
            const headers = currentHeaders.map(h => h.toLowerCase());
            function find(hints) { for (const hint of hints) { const idx = headers.findIndex(x => x.includes(hint)); if (idx>=0) return currentHeaders[idx]; } return null; }
            const map = {
                entreprise: find(['company','employer','entreprise','organisation','soci','societe','companyname']) || '__NONE__',
                poste: find(['title','post','role','job','intitul']) || '__NONE__',
                lieu: find(['location','lieu','city','ville']) || '__NONE__',
                date: find(['date','applied','application','candidature']) || '__NONE__',
                statut: find(['status','statut']) || '__NONE__',
                contact: find(['recruiter','contact','hiring']) || '__NONE__',
                contactInfo: find(['email','phone','telephone']) || '__NONE__',
                salaire: find(['salary','salaire','compensation']) || '__NONE__',
                lienAnnonce: find(['url','link','jobposting','apply']) || '__NONE__',
                notes: find(['note','description','summary','comment']) || '__NONE__'
            };
            for (const k in map) {
                const sel = document.getElementById('map_' + k);
                if (sel) sel.value = map[k];
            }
        }

        function applyMappingImport() {
            if (!currentAllRows) return alert('Aucune donnée à importer.');
            const mapping = {};
            ['entreprise','poste','lieu','date','statut','contact','contactInfo','salaire','lienAnnonce','notes'].forEach(k => {
                const v = document.getElementById('map_' + k).value; mapping[k] = v === '__NONE__' ? null : v;
            });
            const ignoreMissing = document.getElementById('optIgnoreMissing').checked;

            let added = 0, ignored = 0, errors = 0;
            currentAllRows.forEach(r => {
                try {
                    const stage = mapRowWithMapping(r, mapping);
                    if (!stage) { ignored++; return; }
                    if (ignoreMissing && (!stage.entreprise || !stage.poste)) { ignored++; return; }
                    const exists = stages.some(s => (s.lienAnnonce && s.lienAnnonce && stage.lienAnnonce && s.lienAnnonce === stage.lienAnnonce) || (s.entreprise === stage.entreprise && s.poste === stage.poste && s.date === stage.date));
                    if (!exists) { stages.push(stage); added++; } else { ignored++; }
                } catch (err) { console.error(err); errors++; }
            });
            sauvegarderDonnees();
            afficherStages();
            mettreAJourStatistiques();
            closeMappingModal();
            alert('Import terminé — Ajoutés: ' + added + ', Ignorés/Doublons: ' + ignored + ', Erreurs: ' + errors);
        }

        function mapRowWithMapping(row, mapping) {
            function get(h) { if (!h) return ''; return row[h] !== undefined ? row[h] : (row[h.toLowerCase()] !== undefined ? row[h.toLowerCase()] : ''); }
            const entreprise = mapping.entreprise ? String(get(mapping.entreprise)).trim() : '';
            const poste = mapping.poste ? String(get(mapping.poste)).trim() : '';
            const lieu = mapping.lieu ? String(get(mapping.lieu)).trim() : '';
            let date = mapping.date ? String(get(mapping.date)).trim() : '';
            const statut = mapping.statut ? String(get(mapping.statut)).trim() : 'candidature';
            const contact = mapping.contact ? String(get(mapping.contact)).trim() : '';
            const contactInfo = mapping.contactInfo ? String(get(mapping.contactInfo)).trim() : '';
            const salaire = mapping.salaire ? String(get(mapping.salaire)).trim() : '';
            const lienAnnonce = mapping.lienAnnonce ? String(get(mapping.lienAnnonce)).trim() : '';
            const notes = mapping.notes ? String(get(mapping.notes)).trim() : '';

            // normalize date
            if (date) {
                const d = new Date(date);
                if (!isNaN(d)) date = d.toISOString().split('T')[0];
                else {
                    const m = date.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
                    if (m) {
                        const dd = m[1].padStart(2,'0');
                        const mm = m[2].padStart(2,'0');
                        const yyyy = m[3].length === 2 ? ('20' + m[3]) : m[3];
                        date = yyyy + '-' + mm + '-' + dd;
                    } else {
                        date = '';
                    }
                }
            }

            if (!entreprise && !poste) return null;
            return {
                entreprise: entreprise,
                poste: poste,
                lieu: lieu,
                date: date || new Date().toISOString().split('T')[0],
                statut: statut || 'candidature',
                contact: contact,
                contactInfo: contactInfo,
                salaire: salaire,
                lienAnnonce: lienAnnonce,
                notes: notes,
                id: Date.now() + Math.floor(Math.random()*1000)
            };
        }

        // Petit parseur CSV (gère les guillemets et les virgules)
        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
            if (lines.length === 0) return [];

            function parseLine(line) {
                const res = [];
                let cur = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const ch = line[i];
                    if (ch === '"') {
                        if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
                        else { inQuotes = !inQuotes; }
                    } else if (ch === ',' && !inQuotes) {
                        res.push(cur);
                        cur = '';
                    } else { cur += ch; }
                }
                res.push(cur);
                return res;
            }

            const headers = parseLine(lines[0]).map(h => h.trim());
            const rows = lines.slice(1).map(line => {
                const values = parseLine(line);
                const obj = {};
                for (let i = 0; i < headers.length; i++) obj[headers[i]] = values[i] !== undefined ? values[i] : '';
                return obj;
            });
            return rows;
        }

        function mapLinkedInRecord(rec) {
            // rec peut être un objet JSON ou un objet issu d'un CSV (clés en texte)
            // On tente de récupérer les champs courants
            function getField(obj, candidates) {
                if (!obj) return undefined;
                const keys = Object.keys(obj);
                for (const c of candidates) {
                    // direct key
                    if (obj[c] !== undefined) return obj[c];
                    // case-insensitive
                    const found = keys.find(k => k.toLowerCase() === c.toLowerCase());
                    if (found) return obj[found];
                }
                // try scanning values for nesting
                return undefined;
            }

            const entreprise = getField(rec, ['company', 'companyName', 'employer', 'organization', 'entreprise']) || '';
            const poste = getField(rec, ['title', 'jobTitle', 'position', 'poste']) || getField(rec, ['role']) || '';
            const lieu = getField(rec, ['location', 'lieu', 'city']) || '';
            let date = getField(rec, ['appliedAt', 'applicationDate', 'date', 'applied_date']) || '';
            const lien = getField(rec, ['jobPostingUrl', 'url', 'link', 'lien', 'applyUrl']) || '';
            const notes = getField(rec, ['notes', 'note', 'description', 'summary']) || '';

            // Normaliser la date simple (si ISO déjà, ok). Sinon essayer dd/mm/yyyy ou yyyy-mm-dd
            if (date) {
                // remplacer '/' par '-' et essayer de construire
                const d = new Date(date);
                if (!isNaN(d)) date = d.toISOString().split('T')[0];
                else {
                    // try dd/mm/yyyy
                    const m = date.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
                    if (m) {
                        const dd = m[1].padStart(2,'0');
                        const mm = m[2].padStart(2,'0');
                        const yyyy = m[3].length === 2 ? ('20' + m[3]) : m[3];
                        date = yyyy + '-' + mm + '-' + dd;
                    }
                }
            }

            // Si pas de poste/entreprise, on ignore
            if (!entreprise && !poste) return null;

            return {
                entreprise: String(entreprise).trim(),
                poste: String(poste).trim(),
                lieu: String(lieu).trim(),
                date: date || new Date().toISOString().split('T')[0],
                statut: 'candidature',
                contact: '',
                contactInfo: '',
                salaire: '',
                lienAnnonce: lien ? String(lien).trim() : '',
                notes: String(notes || '').trim(),
                id: Date.now() + Math.floor(Math.random()*1000)
            };
        }

        // Event listeners pour les filtres
        document.getElementById('searchInput').addEventListener('input', afficherStages);
        document.getElementById('statusFilter').addEventListener('change', afficherStages);
        document.getElementById('sortBy').addEventListener('change', afficherStages);

        // Fonction pour pré-remplir depuis le lien de l'annonce
        function remplirDepuisLien() {
            const lien = document.getElementById('lienAnnonce').value;
            if (!lien) {
                alert('Veuillez d\'abord saisir le lien de l\'annonce.');
                return;
            }

            // Afficher un indicateur de chargement
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '⏳ Extraction...';
            btn.disabled = true;

            try {
                // Extraction des informations depuis l'URL
                if (lien.includes('welcometothejungle.com')) {
                    extraireWelcomeToJungle(lien, btn, originalText);
                } else if (lien.includes('indeed.com') || lien.includes('indeed.fr')) {
                    extraireIndeed(lien, btn, originalText);
                } else if (lien.includes('linkedin.com')) {
                    extraireLinkedIn(lien, btn, originalText);
                } else {
                    // Pour les autres sites, essayer une extraction générique
                    extraireGenerique(lien, btn, originalText);
                }
            } catch (error) {
                console.error('Erreur lors de l\'extraction:', error);
                resetButton(btn, originalText);
                alert('Impossible d\'extraire les informations automatiquement. Veuillez remplir manuellement.');
            }
        }

        function extraireWelcomeToJungle(lien, btn, originalText) {
            // Parsing de l'URL Welcome to the Jungle pour extraire les informations
            try {
                const url = new URL(lien);
                const pathParts = url.pathname.split('/');
                
                // Structure typique: /fr/companies/company-name/jobs/job-slug
                if (pathParts.includes('companies') && pathParts.includes('jobs')) {
                    const companyIndex = pathParts.indexOf('companies');
                    const jobIndex = pathParts.indexOf('jobs');
                    
                    if (companyIndex >= 0 && jobIndex >= 0 && jobIndex > companyIndex) {
                        const companySlug = pathParts[companyIndex + 1];
                        const jobSlug = pathParts[jobIndex + 1];
                        
                        // Nettoyer et formater le nom de l'entreprise
                        const entreprise = companySlug
                            .split('-')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                            .join(' ');
                        
                        // Nettoyer et formater le poste
                        const poste = jobSlug
                            .split('-')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                            .join(' ');

                        document.getElementById('entreprise').value = entreprise;
                        document.getElementById('poste').value = poste;
                        
                        // Essayer de récupérer plus d'informations si possible
                        setTimeout(() => {
                            resetButton(btn, originalText);
                            alert('✅ Informations extraites avec succès ! Vérifiez et complétez les champs si nécessaire.');
                        }, 500);
                        return;
                    }
                }
            } catch (error) {
                console.error('Erreur Welcome to Jungle:', error);
            }
            
            resetButton(btn, originalText);
            remplirDepuisURL(lien);
        }

        function extraireIndeed(lien, btn, originalText) {
            // Pour Indeed, essayer d'extraire des paramètres de l'URL
            try {
                const url = new URL(lien);
                const params = new URLSearchParams(url.search);
                
                const jobTitle = params.get('q') || params.get('title');
                const location = params.get('l') || params.get('location');
                
                if (jobTitle) {
                    document.getElementById('poste').value = jobTitle;
                }
                if (location) {
                    document.getElementById('lieu').value = location;
                }
                
                setTimeout(() => {
                    resetButton(btn, originalText);
                    alert('✅ Informations partielles extraites ! Complétez le nom de l\'entreprise manuellement.');
                }, 500);
            } catch (error) {
                resetButton(btn, originalText);
                remplirDepuisURL(lien);
            }
        }

        function extraireLinkedIn(lien, btn, originalText) {
            // Pour LinkedIn, extraction basique depuis l'URL
            resetButton(btn, originalText);
            alert('ℹ️ LinkedIn détecté. Les informations doivent être saisies manuellement pour des raisons de sécurité.');
        }

        function extraireGenerique(lien, btn, originalText) {
            resetButton(btn, originalText);
            remplirDepuisURL(lien);
        }

        function remplirDepuisURL(lien) {
            // Extraction basique depuis l'URL du domaine comme nom d'entreprise potentiel
            try {
                const url = new URL(lien);
                const domain = url.hostname.replace('www.', '');
                const domainParts = domain.split('.');
                
                if (domainParts.length > 1) {
                    const companyName = domainParts[0]
                        .split('-')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                    
                    if (!document.getElementById('entreprise').value) {
                        document.getElementById('entreprise').value = companyName;
                    }
                }
                
                alert('ℹ️ Extraction automatique limitée. Veuillez vérifier et compléter les informations.');
            } catch (error) {
                alert('❌ Impossible d\'analyser ce lien. Veuillez remplir manuellement.');
            }
        }

        function resetButton(btn, originalText) {
            btn.textContent = originalText;
            btn.disabled = false;
        }

        // Fonction pour détecter automatiquement le type de lien et suggérer des actions
        document.getElementById('lienAnnonce').addEventListener('input', function() {
            const lien = this.value;
            if (lien) {
                const infoDiv = document.getElementById('lienInfo') || createLienInfo();
                
                if (lien.includes('welcometothejungle.com')) {
                    infoDiv.innerHTML = '🎯 Welcome to the Jungle détecté - Extraction automatique disponible !';
                    infoDiv.className = 'lien-info success';
                } else if (lien.includes('indeed.')) {
                    infoDiv.innerHTML = '🔍 Indeed détecté - Extraction partielle disponible.';
                    infoDiv.className = 'lien-info warning';
                } else if (lien.includes('linkedin.com')) {
                    infoDiv.innerHTML = '💼 LinkedIn détecté - Remplissage manuel requis.';
                    infoDiv.className = 'lien-info info';
                } else if (lien.startsWith('http')) {
                    infoDiv.innerHTML = '🔗 Lien détecté - Extraction basique possible.';
                    infoDiv.className = 'lien-info info';
                } else {
                    infoDiv.innerHTML = '';
                }
            }
        });

        function createLienInfo() {
            const infoDiv = document.createElement('div');
            infoDiv.id = 'lienInfo';
            infoDiv.style.marginTop = '5px';
            infoDiv.style.fontSize = '12px';
            infoDiv.style.padding = '5px';
            infoDiv.style.borderRadius = '3px';
            
            const lienInput = document.getElementById('lienAnnonce');
            lienInput.parentNode.appendChild(infoDiv);
            
            return infoDiv;
        }
    </script>
</body>
</html>